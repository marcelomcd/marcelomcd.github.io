---
description: "DevOps - Pipelines CI/CD, YAML e automação"
alwaysApply: false
---

# DevOps - Pipelines CI/CD e YAML

## Princípios de Pipelines

### Idempotência

Pipelines devem ser **reexecutáveis** sem efeitos colaterais:

```yaml
# ✅ Idempotente (pode reexecutar)
- script: |
    if [ ! -f /tmp/cache/dependencies.tar ]; then
      npm install
      tar -cf /tmp/cache/dependencies.tar node_modules
    fi

# ❌ Não idempotente (pode causar duplicação)
- script: |
    echo "BUILD_NUMBER=$BUILD_ID" >> .env
    # Reexecutar adiciona linha duplicada
```

### Fail Fast

Detectar erros **cedo** no pipeline:

```yaml
# ✅ Validar antes de build pesado
jobs:
  - job: Validate
    steps:
      - script: npm run lint
      - script: npm run type-check
  
  - job: Build
    dependsOn: Validate  # Só roda se Validate passar
    steps:
      - script: npm run build

# ❌ Build primeiro (desperdiça tempo se lint falhar)
jobs:
  - job: Build
    steps:
      - script: npm run build  # Demora 10min
      - script: npm run lint    # Falha (deveria ser primeiro)
```

### Separação de Etapas

```yaml
stages:
  - stage: Quality
    jobs:
      - job: Lint
      - job: Test
  
  - stage: Build
    dependsOn: Quality
    jobs:
      - job: BuildApp
  
  - stage: Deploy
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployProduction
```

**Vantagens**:
- Falha rápida (não fazer build se lint falhar)
- Paralelismo (lint e test simultâneos)
- Clareza (cada etapa com responsabilidade única)

---

## YAML - Estrutura e Padrões

### Indentação e Sintaxe

```yaml
# ✅ Indentação consistente (2 espaços)
stages:
  - stage: Build
    jobs:
      - job: CompileApp
        steps:
          - script: npm run build

# ❌ Mistura de tabs e espaços (causa erros)
stages:
	- stage: Build  # Tab
  - stage: Test     # Espaços
```

### Reutilização (Templates/Anchors)

**YAML Anchors** (quando suportado):

```yaml
# Definir anchor
.node_setup: &node_setup
  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
  - script: npm ci

# Reutilizar
jobs:
  - job: Build
    steps:
      *node_setup
      - script: npm run build
  
  - job: Test
    steps:
      *node_setup
      - script: npm test
```

**Templates** (Azure DevOps):

```yaml
# templates/node-setup.yml
steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
  - script: npm ci

# azure-pipelines.yml
jobs:
  - job: Build
    steps:
      - template: templates/node-setup.yml
      - script: npm run build
```

### Variáveis e Segredos

```yaml
# ✅ Variáveis de grupo/biblioteca (Azure DevOps)
variables:
  - group: production-secrets  # KeyVault-backed
  - name: NODE_ENV
    value: production

# ✅ Usar variáveis em scripts
steps:
  - script: |
      echo "Deploying to $ENVIRONMENT"
      deploy.sh --env $(ENVIRONMENT)
    env:
      DATABASE_URL: $(DATABASE_URL)  # Secret do KeyVault

# ❌ Hardcoded secrets (NUNCA)
steps:
  - script: |
      export DB_PASSWORD="super_secret_123"
      ./deploy.sh
```

**Secrets no log**:
```yaml
# ✅ Marcar variável como secreta
variables:
  - name: API_KEY
    value: $(SecretApiKey)  # Não aparece em logs

# ⚠️ Logs podem expor valores
- script: echo "API_KEY=$API_KEY"  # ❌ Aparece no log
- script: curl -H "Authorization: Bearer $API_KEY"  # ✅ Curl não loga headers por padrão
```

---

## CI/CD Patterns

### Continuous Integration

```yaml
# Pull Request validation
trigger: none  # Não rodar em push

pr:
  branches:
    include:
      - main
      - develop

jobs:
  - job: CI
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '20.x'
      
      - script: npm ci
        displayName: 'Install dependencies'
      
      - script: npm run lint
        displayName: 'Lint code'
      
      - script: npm run test:coverage
        displayName: 'Run tests'
      
      - task: PublishCodeCoverageResults@1
        inputs:
          codeCoverageTool: 'Cobertura'
          summaryFileLocation: 'coverage/cobertura-coverage.xml'
      
      - script: npm run build
        displayName: 'Build application'
```

### Continuous Deployment

```yaml
# Deploy apenas em main
trigger:
  branches:
    include:
      - main

stages:
  - stage: Build
    jobs:
      - job: BuildApp
        steps:
          - script: npm run build
          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: 'dist'
              artifactName: 'app'
  
  - stage: DeployStaging
    dependsOn: Build
    jobs:
      - deployment: DeployToStaging
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: app
                - script: |
                    az webapp deploy \
                      --name myapp-staging \
                      --src-path $(Pipeline.Workspace)/app
  
  - stage: DeployProduction
    dependsOn: DeployStaging
    condition: succeeded()
    jobs:
      - deployment: DeployToProduction
        environment: 'production'  # Requer aprovação manual
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: app
                - script: |
                    az webapp deploy \
                      --name myapp-prod \
                      --src-path $(Pipeline.Workspace)/app
```

---

## Performance e Cache

### Cache de Dependências

```yaml
# ✅ Cache do npm (acelera builds)
steps:
  - task: Cache@2
    inputs:
      key: 'npm | "$(Agent.OS)" | package-lock.json'
      path: $(npm_config_cache)
      restoreKeys: |
        npm | "$(Agent.OS)"
        npm
    displayName: 'Cache npm packages'
  
  - script: npm ci
    displayName: 'Install dependencies'

# ✅ Cache do Docker (layers)
steps:
  - task: Docker@2
    inputs:
      command: 'build'
      Dockerfile: '**/Dockerfile'
      arguments: '--cache-from myapp:latest'
```

### Build Matrix (paralelismo)

```yaml
# Testar em múltiplas versões Node
jobs:
  - job: Test
    strategy:
      matrix:
        Node18:
          node_version: '18.x'
        Node20:
          node_version: '20.x'
        Node22:
          node_version: '22.x'
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: $(node_version)
      - script: npm test
```

---

## Monitoramento e Logs

### Logs Estruturados

```yaml
# ✅ Logs claros e estruturados
steps:
  - script: |
      echo "##[group]Installing dependencies"
      npm ci
      echo "##[endgroup]"
    displayName: 'Install dependencies'
  
  - script: |
      echo "##[section]Running tests"
      npm test
      echo "##[section]Test coverage: $(cat coverage/summary.txt)"
    displayName: 'Test'

# ❌ Logs genéricos
- script: npm ci && npm test
```

### Notificações

```yaml
# Notificar falha (Slack, Teams, Email)
jobs:
  - job: Deploy
    steps:
      - script: ./deploy.sh
    
  - job: NotifyOnFailure
    dependsOn: Deploy
    condition: failed()
    steps:
      - task: Webhook@1
        inputs:
          url: $(SLACK_WEBHOOK)
          body: |
            {
              "text": "Deploy failed: $(Build.BuildNumber)"
            }
```

---

## Segurança

### Scan de Dependências

```yaml
# ✅ Verificar vulnerabilidades
steps:
  - script: npm audit --audit-level=high
    displayName: 'Security audit'
    continueOnError: false  # Falhar se vulnerabilidades críticas
  
  - script: |
      npx snyk test --severity-threshold=high
    env:
      SNYK_TOKEN: $(SnykToken)
```

### Secrets Management

```yaml
# ✅ Azure KeyVault integration
variables:
  - group: keyvault-secrets  # Linked to Azure KeyVault

steps:
  - task: AzureKeyVault@2
    inputs:
      azureSubscription: 'MySubscription'
      keyVaultName: 'mykeyvault'
      secretsFilter: '*'
  
  - script: |
      echo "Using secret from KeyVault"
      ./deploy.sh --api-key $(API-KEY)  # Secret do KeyVault
```

---

## Runners Específicos

### Azure DevOps

```yaml
pool:
  vmImage: 'ubuntu-latest'  # Microsoft-hosted

# Ou self-hosted
pool:
  name: 'Default'  # Agent pool
  demands:
    - agent.name -equals MyAgent
```

### GitHub Actions (para referência)

```yaml
name: CI

on:
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm ci
      - run: npm test
```

---

## Validação de YAML

Antes de commitar pipeline:

```bash
# Validar sintaxe YAML
yamllint azure-pipelines.yml

# Validar Azure DevOps pipeline
az pipelines runs validate \
  --yaml-path azure-pipelines.yml \
  --org https://dev.azure.com/myorg \
  --project myproject
```

**Ferramentas**:
- **yamllint**: validação de sintaxe
- **Azure DevOps Extension**: preview de pipeline no VSCode
- **GitHub Actions**: validação automática ao editar `.github/workflows`
